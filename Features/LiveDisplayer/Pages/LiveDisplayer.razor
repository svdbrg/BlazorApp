@page "/livedisplayer"
@using BlazorApp.Features.LiveDisplayer.Components
@using Data
@using BlazorApp.Features.LiveDisplayer.Services

@inject IFootballDataService _dataFetcher

<PageTitle>Live Display</PageTitle>

@if (isLoading)
{
    <div class="loading">Loading...</div>
}

<div id="table">
    <Table footballTable="table" />
</div>
<div id="fixtures">
    <Fixtures days="days" />
</div>

@code {
    private IEnumerable<Team> table = new List<Team>();
    private List<Day> days = new();
    private bool isLoading = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await GetData();
        }
    }

    private async Task GetData()
    {
        table = await _dataFetcher.GetTableAsync();

        await foreach (var day in _dataFetcher.GetDaysAndFixturesAsync())
        {
            days.Add(day);
            await InvokeAsync(StateHasChanged);
        }

        table = _dataFetcher.EnrichTableWithStatus(table, days);

        isLoading = false;
        await InvokeAsync(StateHasChanged);
    }
}